<ion-button (click)="goBack()" class="back-button-floating-new">
  <ion-icon slot="icon-only" name="arrow-back-outline"></ion-icon>
</ion-button>

<ion-content [fullscreen]="true">
  
  <div *ngIf="movie; else loadingTemplate">
    
    <div class="movie-header">
      <div class="header-image" [style.background-image]="'url(https://image.tmdb.org/t/p/original' + movie.backdrop_path + ')'">
      </div>
      <div class="header-content">
        <div class="poster-container">
          <img [src]="'https://image.tmdb.org/t/p/w500' + movie.poster_path" class="movie-poster" />
        </div>
        <div class="details-text">
          <h1>{{ movie.title }}</h1>
          <p class="tagline">{{ movie.tagline }}</p>
          <p class="genres">{{ genreString }}</p>
          <p class="release-date">{{ movie.release_date | slice:0:4 }}</p>
          <div class="score-container">
            <div *ngIf="criticScore" class="score-item critic-score">
              <ion-icon name="ribbon"></ion-icon>
              <span>{{ criticScore }}/10</span>
              <small>Crítica</small>
            </div>
            <div *ngIf="userScore" class="score-item user-score">
              <ion-icon name="star"></ion-icon>
              <span>{{ userScore }}/10</span>
              <small>Usuarios</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="movie-details-content">
      <h2 class="section-title">Sinopsis</h2>
      <p class="synopsis">{{ movie.overview }}</p>

      <div *ngIf="cast && cast.length > 0">
        <h2 class="section-title">Elenco Principal</h2>
        <div class="cast-list">
          <div *ngFor="let actor of cast" class="actor-card">
            <div *ngIf="actor.profile_path; else noImage" class="actor-image-container">
              <img [src]="'https://image.tmdb.org/t/p/w200' + actor.profile_path" alt="{{ actor.name }}" />
            </div>
            <ng-template #noImage>
              <div class="no-image-placeholder actor-image-container">
                <ion-icon name="person-circle-outline"></ion-icon>
              </div>
            </ng-template>
            <p class="actor-name">{{ actor.name }}</p>
            <p class="character-name">{{ actor.character }}</p>
          </div>
        </div>
      </div>

      <h2 class="section-title">Deja tu Reseña</h2>
      <div class="comment-form-container">
        <form [formGroup]="commentForm" (ngSubmit)="submitComment()" class="comment-form">
          
          <textarea
            formControlName="texto"
            placeholder="Escribe tu opinión aquí..."
            rows="4"
            class="native-textarea"></textarea>
          
          <div *ngIf="commentForm.controls['texto'].touched && commentForm.controls['texto'].errors" class="error-message">
            <p *ngIf="commentForm.controls['texto'].errors['required']">Tu opinión no puede estar vacía.</p>
          </div>
          
          <div class="rating-container">
            <ion-label>Tu Puntuación: {{ commentForm.get('puntuacion')?.value }}/10</ion-label>
            <input 
              type="range"
              formControlName="puntuacion" 
              min="1" 
              max="10" 
              step="1" 
              class="native-range" />
          </div>
          
          <ion-button type="submit" expand="block" [disabled]="commentForm.invalid">
            Publicar Reseña
          </ion-button>
        </form>
      </div>

      <h2 class="section-title">Reseñas de Usuarios</h2>
      <div *ngIf="comments.length === 0; else commentList" class="no-comments">
        <p>Aún no hay reseñas para esta película. ¡Sé el primero en dejar una!</p>
      </div>
      <ng-template #commentList>
        <ion-card class="comment-card" *ngFor="let comment of comments">
          <ion-card-header>
            <ion-card-subtitle>{{ comment.autorNombre }} ({{ comment.autorRol | titlecase }})</ion-card-subtitle>
            <ion-card-title>
              <div class="comment-rating-display">
                <ion-icon *ngFor="let star of getRating(comment.puntuacion)" [name]="star" color="warning"></ion-icon>
                <span class="rating-text">({{ comment.puntuacion }}/10)</span>
              </div>
              <span class="comment-date">{{ comment.fecha | date:'shortDate' }}</span>
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <p>{{ comment.texto }}</p>
            <div *ngIf="canEdit(comment.autor)" class="comment-actions">
              <ion-button fill="clear" color="primary" (click)="handleEdit(comment)">
                <ion-icon name="create-outline"></ion-icon>
              </ion-button>
              <ion-button fill="clear" color="danger" (click)="handleDelete(comment._id)">
                <ion-icon name="trash-outline"></ion-icon>
              </ion-button>
            </div>
          </ion-card-content>
        </ion-card>
      </ng-template>
    </div>
  </div>
  
  <ng-template #loadingTemplate>
    <div class="loading-state ion-padding">
      <ion-skeleton-text [animated]="true" style="width: 60%; height: 30px; margin-bottom: 10px;"></ion-skeleton-text>
      <ion-skeleton-text [animated]="true" style="width: 100%; height: 200px; margin-bottom: 20px;"></ion-skeleton-text>
      <ion-skeleton-text [animated]="true" style="width: 80%; height: 20px;"></ion-skeleton-text>
      <ion-skeleton-text [animated]="true" style="width: 100%; height: 20px;"></ion-skeleton-text>
    </div>
  </ng-template>
</ion-content>